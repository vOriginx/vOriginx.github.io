<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Permissions Policy Test - Inner Iframe</title>
  </head>
  <body>
    <h2>Inner Iframe: Audio Output Test</h2>
    <p>
      This iframe includes <code>speaker-selection</code> in its
      <code>allow</code> attribute and will attempt to use
      <code>setSinkId()</code>.
    </p>

    <button id="play-audio">Play Audio and Set Output Device</button>
    <button id="stop-audio">Stop Audio</button>
    <ul id="device-list"></ul>

    <script>
      async function requestMediaPermissions() {
        try {
          // Request microphone access to get device labels
          await navigator.mediaDevices.getUserMedia({ audio: true });
          console.log('Microphone access granted.');
        } catch (error) {
          console.error('Error accessing microphone:', error);
        }
      }

      async function enumerateDevices() {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          console.log('Devices:', devices);

          const audioOutputDevices = devices.filter(
            (device) => device.kind === 'audiooutput'
          );
          console.log('audioOutputDevices', audioOutputDevices);
          const deviceList = document.getElementById('device-list');
          deviceList.innerHTML = '';

          if (audioOutputDevices.length > 0) {
            audioOutputDevices.forEach((device) => {
              const listItem = document.createElement('li');
              listItem.textContent = `Device: ${
                device.label || 'Unnamed'
              }, ID: ${device.deviceId}`;
              deviceList.appendChild(listItem);
            });
            return audioOutputDevices[0].deviceId;
          } else {
            console.error('No audio output devices found.');
            return null;
          }
        } catch (error) {
          console.error('Error enumerating devices:', error);
          return null;
        }
      }

      const audioElement = new Audio(
        'https://www2.cs.uic.edu/~i101/SoundFiles/BabyElephantWalk60.wav'
      );

      document
        .getElementById('play-audio')
        .addEventListener('click', async () => {
          try {
            await requestMediaPermissions();

            const defaultDeviceId = await enumerateDevices();

            if (
              defaultDeviceId &&
              typeof audioElement.setSinkId === 'function'
            ) {
              await audioElement.setSinkId(defaultDeviceId);
              console.log('Audio output device set successfully.');
              await audioElement.play();
            } else {
              console.log('setSinkId is not supported or no device available.');
              await audioElement.play();
            }
          } catch (error) {
            console.error('Error playing audio or setting device:', error);
          }
        });

      document.getElementById('stop-audio').addEventListener('click', () => {
        audioElement.pause();
        audioElement.currentTime = 0;
        console.log('Audio has been stopped.');
      });
    </script>
  </body>
</html>
